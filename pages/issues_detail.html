<template>
	<report class="max-w-[1440px] relative left-0 right-0 m-auto">

		<!-- Filters Left Start -->
        <div slot="filters" class="flex justify-between w-full">
            <t-container gap-x="2">

                <t-navigation-dropdown label="Select Report Name" />

                <div class="w-[1px] md:relative absolute hidden md:block left-1 bg-[#D3D3D9] h-[28px]"></div>
            
                <div v-if="whoami && whoami.custom_attributes.snyk_user_reports_group_ids.length > 1">
                <!-- only in dev in Topcoat--> 
                    <t-select t-layer="filter_group" t-filter:dropdown="groups" label="Groups" item-label="Groups" />
                    <t-multi-selector is-searchable t-layer="filter_orgs" t-filter:selected_items="orgs"
                    label="Organizations" />
                </div> 
                <div v-else-if="whoami && whoami.custom_attributes.snyk_user_reports_group_ids.length == 1">
                <!-- iframe: selected a group so it should only be org --> 
                    <t-multi-selector is-searchable t-layer="filter_orgs" t-filter:selected_items="orgs"
                    label="Organizations" />
                </div> 
                <div v-else >
                <!-- iframe: no filter because they picked one org --> 
                </div>

                <t-multi-selector t-layer="filter_product_name" t-filter:selected_items="product_name" label="Products" />

                <t-filter-group label="More Filters" max-height="400px">
                    <t-multi-selector is-expanded t-layer="filter_autofixable" t-filter:selected_items="autofixable" item-label="Auto Fixable" /> 
                    <t-tags-input is-single-tag t-layer='filter_cve' item-label="CVE" t-filter:selected_items="cve" :is-label-capitalized="true" /> 
                    <t-tags-input is-single-tag t-layer='filter_cwe' item-label="CWE" t-filter:selected_items="cwe" :is-label-capitalized="true" />  
                    <t-multi-selector is-expanded t-layer="filter_exploit_maturity" t-filter:selected_items="exploit_maturity" item-label="Exploit Maturity" />
                    <t-date-picker t-layer="filter_calendar_introduced" t-filter:start_date="introduced_start" t-filter:end_date="introduced_end" t-filter:date_preset="introduced_range_preset" date-format="YYYY-MM-DD" item-label="Introduced Date" />
                    <t-multi-selector is-expanded t-layer="filter_issue_severity" t-filter:selected_items="issue_severity" item-label="Issue Severity" />
                    <t-multi-selector is-expanded default-value="Open" t-layer="filter_issue_status" t-filter:selected_items="issue_status" item-label="Issue Status" />
                    <t-multi-selector is-expanded t-layer="filter_issue_type" t-filter:selected_items="issue_type" item-label="Issue Type" />
                    <t-date-picker t-layer="filter_calendar_last_introduced" t-filter:start_date="last_introduced_start" t-filter:end_date="last_introduced_end" t-filter:date_preset="last_introduced_range_preset" date-format="YYYY-MM-DD" item-label="Last Introduced Date" />
                    <t-date-picker t-layer="filter_calendar_last_disappeared" t-filter:start_date="last_disappeared_start" t-filter:end_date="last_disappeared_end" t-filter:date_preset="last_disappeared_range_preset" date-format="YYYY-MM-DD" item-label="Last Resolved Date" />
                    <t-range-input t-layer="filter_priority_score" t-filter:min="min" t-filter:max="max" t-min-column="MIN" t-max-column="MAX" item-label="Priority Score" />
                    <t-tags-input is-single-tag t-layer='filter_project_criticality' item-label="Project Criticality" t-filter:selected_items="criticality" :is-label-capitalized="true" /> 
                    <t-tags-input is-single-tag t-layer='filter_project_environment' item-label="Project Environment" t-filter:selected_items="environment" :is-label-capitalized="true" /> 
                    <t-tags-input is-single-tag t-layer='filter_project_lifecycle' item-label="Project Lifecycle" t-filter:selected_items="lifecycle" :is-label-capitalized="true" /> 
                    <t-multi-selector is-expanded t-layer="filter_project_name" t-filter:selected_items="project_name" item-label="Project Name" is-searchable />
                    <t-tags-input t-layer='filter_tags' item-label="Project Tags" t-filter:selected_items="tags" :is-label-capitalized="true" />
                    <t-multi-selector is-expanded t-layer="filter_project_type" t-filter:selected_items="project_type" item-label="Project Type" />
                    <t-multi-selector is-expanded t-layer="filter_reachability" t-filter:selected_items="reachability" item-label="Reachability" />
                </t-filter-group>
            </t-container>
		    <!-- Filters Left End -->

		    <!-- Filters Right Start -->
            <t-container gap-x="2">
                <t-pdf :options="{ paperWidth: 20, paperHeight: 11.5 }" />
                <t-url-copy-button />
            </t-container>
        </div>
		<!-- Filters Right End -->

		<!-- Mid Section Start -->
		<div slot="mid" class="pb-5 md:grid md:grid-cols-3 flex justify-between w-full items-baseline">
			<div class="base-heading text-xl font-normal text-[#211F47] leading-6 w-full">
                <div v-if="whoami && whoami.custom_attributes.snyk_user_reports_group_ids.length == 1">
                    <group-name t-filter:param="groups" t-layer="selected_org" prefix="Issues in" />
                </div> 
                <div v-else-if= "whoami && whoami.custom_attributes.snyk_user_reports_org_ids.length == 1">
                    <org-name t-filter:param="groups" t-layer="selected_org" prefix="Issues in" />
                </div>
			</div>
			<t-container gap-x="2" class="w-full md:col-span-2">
				<span  class="base-heading text-xl font-normal text-[#211F47] leading-6">Issues by</span>
				<t-select t-layer="filter_layer_type" t-filter:dropdown="issue_by" label="Issues By" item-label="Issues_by" default-value="Severity" />
			</t-container>	
		</div>
        <div class="grid md:grid-cols-3 gap-1" slot="mid">
            <t-vis-grouper t-layer="big_num_issue_totals" t-class="grid grid-cols-2 gap-1 w-full">
                <t-big-number label="TOTAL ISSUES" big-number-size="big" t-value-column="TOTAL" height="108" :number-format-limit="9999"/>
                <t-big-number label="UNIQUE VULNS" big-number-size="big" t-value-column="TOTAL_UNIQUE" height="108" :number-format-limit="9999"/>
            </t-vis-grouper>
            <t-container class="md:col-span-2">
                <t-vis-grouper
                    v-if="filters && filters.issue_by === 'Severity'"
                    t-layer="big_number_severity"
                    key="severity"
                    t-class="grid grid-cols-2 md:grid-cols-4 gap-1 w-full"
                >
                    <t-big-number label="CRITICAL" big-number-size="small" bg-color="#FFDAD866" text-color="#8F0018" t-value-column="CRITICAL"  height="108" :number-format-limit="99999">
                        <security-icon slot="icon" size="18" />
                    </t-big-number/>
                    <t-big-number label="HIGH" big-number-size="small" bg-color="#FFDBCC66" text-color="#9B3D15" t-value-column="HIGH" height="108" :number-format-limit="99999">
                        <security-icon slot="icon" size="18" />
                    </t-big-number>
                    <t-big-number label="MEDIUM" big-number-size="small" bg-color="#FFE8CD66" text-color="#925C1E" t-value-column="MEDIUM" height="108" :number-format-limit="99999">
                        <security-icon slot="icon" size="18" />
                    </t-big-number>
                    <t-big-number label="LOW" big-number-size="small" bg-color="#EEEEEE66" t-value-column="LOW" height="108" :number-format-limit="99999">
                        <security-icon slot="icon" size="18" />
                    </t-big-number>
                </t-vis-grouper>
                <t-vis-grouper
                    v-else-if="filters && filters.issue_by === 'Product Name'"
                    t-layer="big_num_product_name"
                    key='product'
                    t-class="grid grid-cols-2 md:grid-cols-4 gap-1 gap-x-1 w-full"
                >
                    <t-big-number label="CODE" big-number-size="small" bg-color="#F9F9FA" t-value-column="SNYK_CODE" height="108" :number-format-limit="99999"/>
                    <t-big-number label="CONTAINER" big-number-size="small" bg-color="#F9F9FA" t-value-column="SNYK_CONTAINER" height="108" :number-format-limit="99999"/>
                    <t-big-number label="IAC" big-number-size="small" bg-color="#F9F9FA" t-value-column="SNYK_IAC" height="108" :number-format-limit="99999"/>
                    <t-big-number label="OPEN SOURCE" big-number-size="small" bg-color="#F9F9FA" t-value-column="SNYK_OPEN_SOURCE" height="108" :number-format-limit="99999"/>      
                </t-vis-grouper>
                <t-vis-grouper
                    v-else-if="filters && filters.issue_by === 'Issue Type'"
                    t-layer="big_num_issue_types"
                    key='issue_type'
                    t-class="grid grid-cols-2 md:grid-cols-3 gap-1 gap-x-1 w-full"
                >
                    <t-big-number label="VULNERABILITY" big-number-size="small" bg-color="#F9F9FA" t-value-column="VULNERABILITY" height="108" :number-format-limit="99999"/>
                    <t-big-number label="CONFIGURATION" big-number-size="small" bg-color="#F9F9FA" t-value-column="CONFIGURATION" height="108" :number-format-limit="99999"/>
                    <t-big-number label="LICENSE" big-number-size="small" bg-color="#F9F9FA" t-value-column="LICENSE" height="108" :number-format-limit="99999"/>    
                </t-vis-grouper>
            </t-container>
        </div>

        <!-- sort="sql" -->
        <TTable 
            title="Issue details" 
            t-layer="issue_table" 
            full_width 
            :can-search="false" 
            :is-header-fixed="true"
            :canPageServer="true"
            :layerColumnsToHide="['ISSUE_TYPE','PROBLEM_ID','PROJECT_URL','ISSUE_URL','ISSUE_STATUS_INDICATOR']"
            :modifiableColumns="[
                    {
                        displayColumn: 'SCORE',
                        layerColumns: ['PRIORITY_SCORE'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'CVE',
                        layerColumns: ['CVE'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'CWE',
                        layerColumns: ['CWE'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'PROJECT',
                        layerColumns: ['PROJECT_NAME'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'EXPLOIT MATURITY',
                        layerColumns: ['EXPLOIT_MATURITY'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'AUTO FIXABLE',
                        layerColumns: ['AUTOFIXABLE'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'INTRODUCED',
                        layerColumns: ['FIRST_INTRODUCED'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'ISSUE STATUS',
                        layerColumns: ['ISSUE_STATE'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'LAST INTRODUCED',
                        layerColumns: ['LAST_INTRODUCED'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'LAST RESOLVED',
                        layerColumns: ['LAST_DISAPPEARED'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'PRODUCT',
                        layerColumns: ['PRODUCT_NAME'],
                        displayByDefault: true,
                    },
                    {
                        displayColumn: 'PROJECT CRITICALITY',
                        layerColumns: ['CRITICALITY_DISPLAY'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'PROJECT ENVIRONMENT',
                        layerColumns: ['ENVIRONMENT_DISPLAY'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'PROJECT LIFECYCLE',
                        layerColumns: ['LIFECYCLE_DISPLAY'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'PROJECT TAGS',
                        layerColumns: ['KEY_VALUE_DISPLAY'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'PROJECT TYPE',
                        layerColumns: ['PROJECT_TYPE'],
                        displayByDefault: false,
                    },
                    {
                        displayColumn: 'REACHABILITY',
                        layerColumns: ['REACHABILITY'],
                        displayByDefault: false,
                    },
                ]">
            <t-column header=" " id-or-name="ISSUE_SEVERITY">
                <IssueSeverityIcon :severity="value" />
            </t-column>
            <t-column header="SCORE" id-or-name="PRIORITY_SCORE">
                {{ parseInt(rendered_value, 10) }}
            </t-column>
            <t-column header="ISSUE" id-or-name="PROBLEM_TITLE">
                <div class="text-[#145DEB] text-sm font-medium leading-[15px] tracking-[0.1px]">{{row.ISSUE_TYPE.value}}</div>
                <span v-if="row.ISSUE_STATUS_INDICATOR.value == 'Open'">
                    <TUrl :url="row.ISSUE_URL.value" :includeFilterParams="false"> {{rendered_value}} </TUrl>
                </span>
                <span v-else>
                    {{rendered_value}}
                </span>
            </t-column>
            <t-column header="CVE" id-or-name="CVE">
                <div class="text-[#145DEB] text-sm font-normal">
                    <span v-for=="CVE in JSON.parse(value)">
                        <TUrl :url="'https://www.cve.org/CVERecord?id='+CVE" :includeFilterParams="false"> {{ CVE }} </TUrl>
                    </span>
                </div>
            </t-column>
            <t-column header="CWE" id-or-name="CWE">
                <div class="text-[#145DEB] text-sm font-normal">
                    <span v-for=="CWE in JSON.parse(value)">
                        <TUrl :url="'https://cwe.mitre.org/data/definitions/'+CWE.replace('CWE-', '')"
                            :includeFilterParams="false"> {{ CWE }} </TUrl>
                    </span>
                </div>
            </t-column>
            <t-column header="PROJECT" id-or-name="PROJECT_NAME">
                <TUrl :url="row.PROJECT_URL.value" :includeFilterParams="false"> {{rendered_value}} </TUrl>
            </t-column>
            <t-column header="EXPLOIT MATURITY" id-or-name="EXPLOIT_MATURITY">
                <span v-if="rendered_value">
                    {{ rendered_value.split('-').map((w) => _.capitalize(w)).join(' ') }}
                </span>
            </t-column>
            <t-column header="AUTO FIXABLE" id-or-name="AUTOFIXABLE">
                <span v-if="value !== 'No' && value !== null" class="flex text-sm text-normal text-[#727184] leading-[17px]">
                    <i class="fas fa-check-circle text-[#2D9283] mr-[6px]"></i> {{value}}
                </span>
                <span v-else class="flex text-sm text-normal text-[#727184] leading-[17px]">
                    <div>{{ value }}</div>
                </span>
            </t-column>
            <t-column header="INTRODUCED" id-or-name="FIRST_INTRODUCED">
                  <date-formatter :date="value" /> 
            </t-column> 
            <t-column header="LAST INTRODUCED" id-or-name="LAST_INTRODUCED">
                  <date-formatter :date="value" /> 
            </t-column> 
            <t-column header="LAST RESOLVED" id-or-name="LAST_DISAPPEARED">
                <date-formatter :date="value" />
            </t-column>
            <t-column header="PROJECT CRITICALITY" id-or-name="CRITICALITY_DISPLAY" />
            <t-column header="PROJECT ENVIRONMENT" id-or-name="ENVIRONMENT_DISPLAY" />
            <t-column header="PROJECT LIFECYCLE" id-or-name="LIFECYCLE_DISPLAY" />
            <t-column header="PROJECT TAGS" id-or-name="KEY_VALUE_DISPLAY" />
            <t-column header="PRODUCT" id-or-name="PRODUCT_NAME" />
            <t-column header="PROJECT TYPE" id-or-name="PROJECT_TYPE" />
            <t-column header="ISSUE STATUS" id-or-name="ISSUE_STATE" />
        </TTable>
	  <!-- Layers End -->

	</report>
</template>
